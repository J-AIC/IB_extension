# 1. 介绍

无需注册，轻松设置！  
InsightBuddy Extension 是一个可在网站上使用的 AI 聊天助手。只需为您首选的 AI 提供商（无论是 OpenAI、Anthropic、Google 还是其他）设置 API 密钥，即可立即开始使用。  
此外，它还可以连接到您自托管的兼容 OpenAI 的环境。

- 截至 2025 年 2 月，Google 的 Gemini 部分功能免费，因此如果利用这一优势，您可以免费使用生成式 AI。
- 下文文章总结了如何设置账户 ( https://j-aic.com/techblog/google-ai-studio-api-free )。

## 1.1 主要特点

- 支持多种 AI 提供商
- 支持考虑网站内容的对话
- 包含聊天记录保存功能
- 通过使用指南功能，您可以在指定网站上执行特定操作

## 1.2 信息处理

- API 密钥和聊天记录仅存储在您设备的本地。
- 有关通过聊天功能发送数据的处理方式的详细信息，请查阅各模型提供商的服务条款。
- 本公司不会仅通过此功能收集使用数据或其他信息。

---

# 2. 初始设置

## 2.1 配置 API 提供商的步骤

1. **打开 API 设置界面**  
   - 在屏幕右下角打开聊天小工具  
   - 点击底部菜单中的“主页”图标  
   - 在左侧菜单中点击“API 设置”
2. **选择提供商并设置 API 密钥**  
   - 找到所需 AI 提供商的卡片  
   - 点击齿轮图标进入配置模式  
   - 输入您的 API 密钥  
   - 点击“保存”
3. **选择模型**  
   - 在提供商卡片上点击“选择模型”  
   - 从可用模型列表中选择
4. **启用提供商**  
   - 配置完成后，打开切换开关  
   - 一旦配置正确，状态显示将更新

## 2.2 支持的提供商

### OpenAI

- 密钥格式：以 `sk-` 开头的字符串
- 主要模型：GPT-4, GPT-3.5-turbo
- API 密钥获取：可在 OpenAI 官网获得

### Anthropic

- 密钥格式：以 `sk-ant-api` 开头的字符串
- 主要模型：Claude-3-Opus, Claude-3-Sonnet
- API 密钥获取：可在 Anthropic 官网获得

### Google Gemini

- 密钥格式：以 `AIza` 开头的字符串
- 主要模型：gemini-pro
- API 密钥获取：可在 Google Cloud Console 获得

### Deepseek

- 密钥格式：以 `sk-ds-api` 开头的字符串
- 主要模型：Deepseek-LLM, Deepseek-XL
- API 密钥获取：可在 Deepseek 官网获得

### 兼容 OpenAI

- 密钥格式：任意字符串（依据提供商的规格）
- 主要模型：提供商提供的兼容 OpenAI 的模型
- API 密钥获取：可在各提供商官网获得
- 特别说明：
  - 需要自定义端点 URL 配置
  - 需要手动输入模型名称
  - 可用于任何提供兼容 OpenAI API 的服务

### 本地 API

- 这是 InsightBuddy 的专有 API。
- 使用需另行签订协议。
- 提供诸如表单读取和表单输入接口等功能。

---

# 3. 基本用法

## 3.1 开始聊天

1. 点击浏览器右侧的蓝色标签。
2. 聊天小工具将会打开。
3. 在底部的输入框中输入您的消息。
4. 点击发送按钮或按回车键发送。

## 3.2 使用聊天功能

- **开始新聊天**  
  - 点击右上角的 “+” 图标。
- **查看聊天记录**  
  - 点击底部菜单中的时钟图标。  
  - 选择过去的对话以进行查看。
- **利用网站内容**  
  - 启用后，“获取当前网站内容”选项允许助手在生成回复时考虑当前页面的内容。

---

# 4. 故障排除

## 4.1 常见错误及解决方案

### API 密钥错误

- **症状**：显示 “API 密钥无效” 的错误。
- **解决方案**：
  1. 验证 API 密钥格式是否正确。
  2. 检查 API 密钥的有效期。
  3. 如有需要，请获取新的 API 密钥。

### 连接错误

- **症状**：无法发送消息。
- **解决方案**：
  1. 检查您的网络连接。
  2. 重新加载浏览器。
  3. 检查 API 提供商的状态。

### 模型选择错误

- **症状**：无法选择模型。
- **解决方案**：
  1. 验证 API 密钥的权限。
  2. 检查提供商的使用限制。
  3. 尝试选择其他模型。

### 兼容 OpenAI 的连接错误

- **症状**：无法连接或未收到响应。
- **解决方案**：
  1. 验证端点 URL 是否正确。
  2. 确保输入的模型名称符合提供商的规格。
  3. 确认 API 密钥格式符合提供商要求。
  4. 检查提供商的服务状态。

## 4.2 重置配置

1. 打开 API 设置界面。
2. 关闭每个提供商的设置。
3. 重新输入 API 密钥。
4. 重新选择模型。

---

# 5. 安全与隐私

## 5.1 数据处理

- API 密钥以加密形式仅存储在您设备的本地。
- 聊天记录仅存储在本地。
- 网站信息仅在必要范围内使用。

## 5.2 推荐的安全措施

- 定期更新 API 密钥。
- 禁用未使用的提供商。
- 检查您的浏览器隐私设置。

## 5.3 检查更新

- 确保启用了 Chrome 扩展程序的自动更新。
- 定期检查并更新您的设置。

---

# 6. 技术规格

## 6.1 多轮对话系统

### 基本设计

- **最多保留对话轮数：** 4 轮  
  - 限制轮数以优化令牌使用。
  - 一轮 = 用户消息 + AI 回复。
  - 从第 5 轮开始，最早的轮次将被移除。

### 实现的对话管理

- **对话历史以 Markdown 格式管理**  
  - **最近对话：** 过去的对话历史  
  - **当前用户消息：** 当前输入  
  - **页面上下文：** 当前网页信息（可选）  
  - **Markdown 配置：**

    ```markdown
    # 最近对话
    ## 第 1 轮
    ### 用户
    用户的消息内容
    ### 助手
    AI 的回复内容
    # 当前用户消息
    当前用户的消息
    # 页面上下文（可选）
    网页内容
    ```

- **每个请求附加了一个系统提示**  
  - 回复将使用用户的语言。
  - 对装饰和 Markdown 的使用有限制。
  - 确保整个对话的一致性。
  - **系统提示配置：**

    ```text
    你是一个高性能的 AI 助手。请按照以下指示进行回复：

    # 基本行为
    - 用户发布的消息存储在 ("当前用户消息") 中。
    - 请使用用户在 ("当前用户消息") 中使用的语言进行回复。
    - 保持回复简洁且准确。
    - 不要使用装饰或 Markdown 格式。

    # 处理对话历史
    - 通过参考提供的 Markdown 格式对话历史 ("最近对话") 来理解上下文。
    - 每一轮以 "第 X 轮" 提供，包含用户与助手之间的对话。
    - 力求回复与之前的对话保持一致。

    # 处理网页信息
    - 如果存在 "页面上下文" 部分，请在回答时考虑该网页的内容。
    - 将网页信息作为补充，仅引用与用户问题直接相关的部分。
    ```

---

## 6.2 上下文处理系统

### 获取网页信息

- **为优化令牌使用的实现**
  - 每次查询都重新获取网页内容（不会保存到历史记录中）。
  - 通过优化 HTML 来减少令牌使用。
  - 移除不必要的元素（例如 `<script>`、`<style>`、`<iframe>` 等）。
- **页面上下文切换功能**
  - 允许用户开启或关闭该功能。
  - 使用本地 API 时自动启用。

### 表单读取功能

- 自动识别表单元素。
- **与 PDF 解析功能的集成**
  - 自动检测 PDF 文件。
  - 文本提取过程。
  - 与原始表单上下文的集成。

---

## 6.3 提供商管理系统

### 提供商特定实现

- **OpenAI / Deepseek**
  - 使用 Bearer 认证。
  - 支持自动获取模型。
- **Anthropic**
  - 使用 x-api-key 认证。
  - 需要指定版本（例如，2023-06-01）。
- **Google Gemini**
  - 使用 API 密钥进行认证。
  - 支持独特的响应格式。
- **兼容 OpenAI**
  - 支持自定义端点配置。
  - 需要手动设置模型名称。
  - 允许自定义认证方法。
- **本地 API**
  - 支持自定义端点。
  - 使用专有的认证系统。

### 提供商切换功能

- 一次只能启用一个提供商。
- 执行配置完整性检查：
  - 验证 API 密钥格式。
  - 检查所需的配置项。
  - 验证是否已选择模型。

---

## 6.4 历史记录管理系统

### 实现的保存功能

- 最多保留 30 条对话历史。
- **保存的数据包括：**
  - 提供商信息
  - 所选模型
  - 时间戳
  - 消息历史
- **与 Chrome 存储 API 的集成：**
  - 支持扩展间的数据共享。
  - 使用本地存储作为后备。

### 历史记录功能

- **对话编辑功能**
  - 允许编辑消息。
  - 编辑后重新生成回复。
  - 自动更新后续消息。
- 历史记录过滤。
- **提供商兼容性检查**
  - 验证所选模型与提供商是否匹配。
  - 如有需要，显示兼容性警告。

---

## 6.5 聊天小工具的实现

### UI/UX 功能

- **使用 iframes 实现**
  - 与父页面隔离。
  - 通过消息传递进行通信。
- **响应式设计**
  - 根据屏幕大小调整显示。
  - 自动调整输入区域的大小。

### 特殊功能

- **显示网站信息**
  - 呈现 HTML 内容。
  - 显示表单内容。
- **消息管理**
  - 创建新聊天。
  - 编辑并重新发送聊天（注意：不允许重复使用网页信息）。
  - 切换聊天记录的显示。

---

## 6.6 安全实现

### API 管理

- **API 密钥的安全存储**
  - 使用 Chrome 存储 API。
  - 显示时隐藏密钥。

### 数据保护

- **限制页面上下文**
  - 仅获取必要的信息。
  - 排除敏感数据。
- **本地数据管理**
  - 管理会话数据。

---

## 6.7 调试日志

- 输出以下调试日志：

  ```javascript
  console.group('外部 API 传输调试信息');
  console.log('发送的消息:', message);
  console.log('API 配置:', {
      provider: apiConfig.provider,
      model: apiConfig.model,
      customSettings: apiConfig.customSettings
  });
  console.log('API 响应:', result);
  console.groupEnd();